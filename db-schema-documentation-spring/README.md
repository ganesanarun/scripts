## Database Schema Management

### Overview

Script and Makefile targets to automate the process of exporting Postgres database schemas, converting them to DBML
format, and rendering the [DBML](https://dbml.dbdiagram.io/home/) to SVG image. This process helps in visualizing and
managing your database schema
effectively.

Database connection details are extracted from **spring application configuration** to reduce manual effort. In case of
non-spring based applications, you can provide the database connection details in the `application-{profile}.yml` file
or pass them as environment variables.

### Prerequisites

- **pg_dump**: Ensure `pg_dump` is installed and available in your PATH.
    ```shell
    # Install on macOS
    brew install libpq
    ```
- **sql2dbml**: Install via npm:
  ```sh
  npm install -g @dbml/cli
  ```
- **dbml-renderer**: Install via npm:
  ```sh
  npm install -g @softwaretechnik/dbml-renderer
  ```
- **yq**: Ensure `yq` is installed and available in your PATH. Installation instructions can be
  found [here](https://mikefarah.gitbook.io/yq/).
- **awk**: Ensure `awk` is installed and available in your PATH.
    ```shell
    # Install on macOS
    brew install gawk
    ``` 

### Scripts and Makefile Targets

#### Export Schema Script

The script `export-schema.sh` is used to export the DDL of your Postgres database schema. It defaults to
using the `local` Spring profile and the `public` schema if no profile or schema is specified.

#### Makefile Targets

The Makefile includes several targets to streamline the schema management process:

- **Validate Tools**: Checks if `sql2dbml`,`dbml-renderer`, `pg_dump`, `awk`, and `yq` are installed.
    - `make validate-dependencies`

- create the necessary directories if they don't exist
    - `make create-directories:`

- **Export Schema**: Export the database schema.
    - `make export-schema PROFILE=<profile>`: Export schema of the database.

- **Convert to DBML**: Converts the exported DDL file to DBML format.
    - `make convert-to-dbml`

- **Render DBML**: Renders the DBML file to SVG or PNG format.
    - `make render-svg`

- **Full Process**: Combines the steps of exporting the schema, converting to DBML, and rendering to SVG/PNG.
    - `make document-schema PROFILE=<profile>`

## Sample Files

- `docs/sql/ddl.sql`: Sample SQL file containing the database schema, which was exported using the `export-schema.sh`
  script.
- `docs/dbml/schema.dbml`: Sample DBML file generated by converting the `ddl.sql` file using the `sql2dbml` tool.
- `docs/svg/schema.svg`: Sample SVG file generated by rendering the `schema.dbml` file using the `dbml-renderer` tool.

## Conclusion

Automating the process of exporting, converting, and rendering the database schema helps in visualizing and managing the
database schema effectively.

This process can be further extended to include additional steps like updating the schema documentation in the README
file or pushing the updated schema to a documentation repository.
